<div class="container-fluid mt-4">
  <div class="header-with-back-button">
    <button mat-icon-button routerLink="/dashboard" aria-label="Back to Dashboard">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2 class="text-center text-primary mb-4 flex-grow-1">Stock Management</h2>
  </div>

  <div class="row align-items-center mb-3">
      <div class="col-md-4 col-sm-12">
          <input type="text" [(ngModel)]="searchQuery" class="form-control search-box"
                 placeholder="ðŸ” Search by Name or Category" (input)="searchStocks()">
      </div>
      <div class="col-md-4 col-sm-12 text-center">
          </div>
      <div class="col-md-4 col-sm-12 text-end">
          <button class="btn btn-primary" (click)="toggleCreateForm()">Create Stock</button>
      </div>
  </div>

  <div class="row align-items-center mb-3">
      <div class="col-md-6 col-sm-12 d-flex align-items-center justify-content-start">
          <div class="d-flex align-items-center me-3"> <label for="vendorSearchQuery" class="me-2 text-dark">Vendor ID:</label>
              <input type="number" id="vendorSearchQuery" [(ngModel)]="vendorSearchQuery"
                     class="form-control form-control-sm bg-success text-white border-dark custom-filter-input"
                     placeholder="Vendor ID" (input)="searchByVendor(vendorSearchQuery)">
          </div>
          <div class="d-flex align-items-center">
              <label for="zoneSearchQuery" class="me-2 text-dark">Zone ID:</label>
              <input type="number" id="zoneSearchQuery" [(ngModel)]="zoneSearchQuery"
                     class="form-control form-control-sm bg-primary text-white border-dark custom-filter-input"
                     placeholder="Zone ID" (input)="searchByZone(zoneSearchQuery)">
          </div>
      </div>
      <div class="col-md-6 col-sm-12 d-flex justify-content-end">
          <div class="btn-group" role="group" aria-label="View Toggle">
              <button type="button" class="btn btn-outline-secondary" [class.active]="!showCardView" (click)="toggleView(false)">
                  <i class="fas fa-table"></i> Table View
              </button>
              <button type="button" class="btn btn-outline-secondary" [class.active]="showCardView" (click)="toggleView(true)">
                  <i class="fas fa-th-large"></i> Card View
              </button>
          </div>
      </div>
  </div>

  <div *ngIf="showCreateForm" class="overlay">
      <div class="modal-content">
          <h3>Add New Stock Item</h3>
          <form (ngSubmit)="createStock()">
              <div class="form-group">
                  <label>Stock Name:</label>
                  <input type="text" [(ngModel)]="newStock.stockName" name="stockName" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Stock Category:</label>
                  <input type="text" [(ngModel)]="newStock.stockCategory" name="stockCategory" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Stock Quantity:</label>
                  <input type="number" [(ngModel)]="newStock.stockQuantity" name="stockQuantity" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Zone:</label>
                  <select [(ngModel)]="newStock.zoneId" (change)="onZoneChange(newStock.zoneId)" name="zoneId" required class="form-control">
                      <option [value]="0" disabled selected>Select Zone</option>
                      <option *ngFor="let zone of zones" [value]="zone.zoneId">{{ zone.zoneId }} - {{ zone.zoneName }}</option>
                  </select>
              </div>
              <div class="form-group">
                  <label>Vendor:</label>
                  <select [(ngModel)]="newStock.vendorId" name="vendorId" required class="form-control">
                      <option [value]="0" disabled selected>Select Vendor</option>
                      <option *ngFor="let vendor of vendors" [value]="vendor.vendorId">{{ vendor.vendorId }} - {{ vendor.vendorName }}</option>
                  </select>
              </div>
              <div class="form-group d-flex justify-content-between">
                  <button type="submit" class="btn btn-success">Submit</button>
                  <button type="button" class="btn btn-secondary" (click)="toggleCreateForm()">Cancel</button>
              </div>
          </form>
      </div>
  </div>

  <div *ngIf="!showCardView" class="table-responsive shadow-lg rounded">
      <table class="table table-striped table-bordered text-center stock-table">
          <thead class="table-dark">
              <tr>
                  <th>Stock ID</th>
                  <th>Name</th>
                  <th>Category</th>
                  <th>Quantity</th>
                  <th>Zone ID</th>
                  <th>Vendor ID</th>
                  <th>Edit</th>
                  <th>Delete</th>
              </tr>
          </thead>
          <tbody>
              <tr *ngFor="let stock of pagedStocks">
                  <td>{{ stock.stockId }}</td>
                  <td>{{ stock.stockName }}</td>
                  <td>{{ stock.stockCategory }}</td>
                  <td [class.text-danger]="stock.stockQuantity < 10" [class.text-warning]="stock.stockQuantity >=10 && stock.stockQuantity <=20">{{ stock.stockQuantity }}</td>
                  <td>{{ stock.zoneId }}</td>
                  <td>{{ stock.vendorId }}</td>
                  <td class="text-center">
                      <i class="fas fa-edit text-primary cursor-pointer" (click)="editStock(stock)"></i>
                  </td>
                  <td class="text-center">
                      <i class="fas fa-trash text-danger cursor-pointer" (click)="deleteStock(stock)"></i>
                  </td>
              </tr>
          </tbody>
      </table>
      <p *ngIf="pagedStocks.length === 0" class="text-muted text-center py-3">No stocks found matching your criteria.</p>
  </div>

  <div *ngIf="showCardView" class="card-view-container mt-4">
      <div *ngIf="pagedStocks.length > 0; else noStocksFound">
          <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
              <div class="col" *ngFor="let stock of pagedStocks">
                  <div class="card h-100 shadow-sm border-0 stock-card">
                      <img [src]="getStockImage(stock.stockCategory)" class="card-img-top card-img-custom" alt="{{ stock.stockName }}">
                      <div class="card-body d-flex flex-column">
                          <h5 class="card-title text-truncate">{{ stock.stockName }}</h5>
                          <p class="card-text text-muted mb-1"><small>Category: {{ stock.stockCategory }}</small></p>
                          <p class="card-text fw-bold mb-2">Quantity: <span [class.text-danger]="stock.stockQuantity < 10" [class.text-warning]="stock.stockQuantity >=10 && stock.stockQuantity <=20">{{ stock.stockQuantity }}</span></p>

                          <ul class="list-group list-group-flush mb-3 mt-auto border-top pt-2">
                              <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0 bg-transparent">
                                  <small>Zone ID:</small>
                                  <span class="badge bg-secondary rounded-pill">{{ stock.zoneId }}</span>
                              </li>
                              <li class="list-group-item d-flex justify-content-between align-items-center py-1 px-0 bg-transparent">
                                  <small>Vendor ID:</small>
                                  <span class="badge bg-info text-dark rounded-pill">{{ stock.vendorId }}</span>
                              </li>
                          </ul>
                          <div class="d-flex justify-content-around mt-auto card-actions">
                              <button class="btn btn-outline-primary btn-sm flex-grow-1 me-1" (click)="editStock(stock)">
                                  <i class="fas fa-edit"></i> Edit
                              </button>
                              <button class="btn btn-outline-danger btn-sm flex-grow-1 ms-1" (click)="deleteStock(stock)">
                                  <i class="fas fa-trash"></i> Delete
                              </button>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <ng-template #noStocksFound>
          <p class="text-muted text-center py-5">No stocks found matching your criteria.</p>
      </ng-template>
  </div>

  <nav *ngIf="totalPages > 1" class="mt-4">
      <ul class="pagination justify-content-center">
          <li class="page-item" [class.disabled]="currentPage === 1">
              <button class="page-link" (click)="changePage(currentPage - 1)" aria-label="Previous">
                  <span aria-hidden="true">&laquo;</span>
              </button>
          </li>
          <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index">
              <button class="page-link" [class.active]="currentPage === i + 1" (click)="changePage(i + 1)">{{ i + 1 }}</button>
          </li>
          <li class="page-item" [class.disabled]="currentPage === totalPages">
              <button class="page-link" (click)="changePage(currentPage + 1)" aria-label="Next">
                  <span aria-hidden="true">&raquo;</span>
              </button>
          </li>
      </ul>
  </nav>

  <div *ngIf="editingStock" class="overlay">
      <div class="modal-content">
          <h3>Update Stock Item</h3>
          <form (ngSubmit)="updateStock()">
              <div class="form-group">
                  <label>Stock ID:</label>
                  <input type="text" [(ngModel)]="editingStock.stockId" name="stockId" class="form-control" readonly>
              </div>
              <div class="form-group">
                  <label>Stock Name:</label>
                  <input type="text" [(ngModel)]="editingStock.stockName" name="stockName" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Stock Category:</label>
                  <input type="text" [(ngModel)]="editingStock.stockCategory" name="stockCategory" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Stock Quantity:</label>
                  <input type="number" [(ngModel)]="editingStock.stockQuantity" name="stockQuantity" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Zone ID:</label>
                  <input type="number" [(ngModel)]="editingStock.zoneId" name="zoneId" required class="form-control">
              </div>
              <div class="form-group">
                  <label>Vendor ID:</label>
                  <input type="number" [(ngModel)]="editingStock.vendorId" name="vendorId" required class="form-control">
              </div>
              <div class="form-group d-flex justify-content-between">
                  <button type="submit" class="btn btn-warning">Update</button>
                  <button type="button" class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
              </div>
          </form>
      </div>
  </div>
</div>